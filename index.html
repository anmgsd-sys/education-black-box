<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Black Box Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            text-align: center;
            padding: 20px;
            margin: 0;
        }
        .container { max-width: 850px; margin: 40px auto; }
        .card {
            background-color: #ffffff; padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); 
        }
        h1 { color: #1a237e; margin-bottom: 10px; }
        .btn {
            padding: 12px 25px; font-size: 16px; font-weight: 600;
            border: none; border-radius: 8px; cursor: pointer; margin: 10px;
            transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); }
        .start { background-color: #1a237e; color: white; }
        .stop { background-color: #d32f2f; color: white; }
        .download { background-color: #f57c00; color: white; width: 100%; margin-top: 20px;}
        .btn:disabled { background-color: #e9ecef; color: #adb5bd; cursor: not-allowed; transform: none; box-shadow: none;}
        
        #audioVisualizer {
            width: 100%; height: 150px; background-color: #f8f9fa;
            border-radius: 10px; margin-top: 20px; border: 1px solid #e9ecef;
        }
        .speaker-box {
            margin: 20px auto; padding: 15px; width: 70%;
            background-color: #e3f2fd; color: #1565c0;
            font-size: 18px; font-weight: bold;
            border-radius: 10px; border: 2px solid #bbdefb;
        }
        .teacher-mode { background-color: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
        .student-mode { background-color: #fff3e0; color: #e65100; border-color: #ffe0b2; }

        /* –ú–û–î–ê–õ–¨–î–´ –¢–ï–†–ï–ó–ï (–ë–µ—Ç—Ç—ñ –∂–∞—É—ã–ø —Ç“±—Ä–∞—Ç—ã–Ω) */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; /* –ï“£ –∂–æ“ì–∞—Ä—ã “õ–∞–±–∞—Ç */
        }
        .modal-content {
            background: #ffffff; padding: 40px; border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); width: 350px;
        }
        input {
            width: 100%; padding: 12px; margin: 10px 0;
            border-radius: 8px; border: 1px solid #ced4da;
            font-size: 16px; box-sizing: border-box;
        }
        .hidden { display: none !important; }
        .blur { filter: blur(5px); pointer-events: none; }
        .active-container { filter: none; pointer-events: all; }
        .info-bar { background: #e8eaf6; padding: 12px; border-radius: 8px; color: #3949ab; font-weight: bold; border-left: 5px solid #1a237e; }
        
        /* PDF –¥“±—Ä—ã—Å—Ç–∞—É */
        #analysisResult { background-color: white; color: black; overflow: visible !important; height: auto !important; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>üîê –°–∞–±–∞“õ—Ç—ã –±–∞—Å—Ç–∞—É</h2>
            <p>–î–µ—Ä–µ–∫—Ç–µ—Ä —Ö–∞—Ç—Ç–∞–º–∞“ì–∞ –∂–∞–∑—ã–ª–∞–¥—ã</p>
            
            <input type="text" id="teacherNameInput" placeholder="–ú“±“ì–∞–ª—ñ–º–Ω—ñ“£ –ê—Ç—ã-–ñ”©–Ω—ñ">
            <input type="text" id="subjectInput" placeholder="–ü”ô–Ω (–ú—ã—Å–∞–ª—ã: –§–∏–∑–∏–∫–∞)">
            <input type="text" id="gradeInput" placeholder="–°—ã–Ω—ã–ø (–ú—ã—Å–∞–ª—ã: 10 '–ê')">
            
            <button id="saveInfoBtn" class="btn start" onclick="saveData()">‚úÖ –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Ä–∞—Å—Ç–∞—É</button>
        </div>
    </div>

    <div class="container blur" id="mainContainer">
        <div class="card"> 
            <h1>Education Black Box ‚¨õ</h1>
            
            <div id="sessionInfo" class="info-bar">
                üë§ –ú“±“ì–∞–ª—ñ–º: <span id="displayTeacher">...</span> | üìö –ü”ô–Ω: <span id="displaySubject">...</span>
            </div>

            <div class="controls">
                <button id="startBtn" class="btn start" onclick="startAnalysis()" disabled>üéô –¢–∞–ª–¥–∞—É–¥—ã –±–∞—Å—Ç–∞—É</button>
                <button id="stopBtn" class="btn stop" onclick="stopAnalysis()" disabled>üõë –ê—è“õ—Ç–∞—É</button>
            </div>

            <div id="speakerIndicator" class="speaker-box">üîä –î–∞–π—ã–Ω–¥—ã“õ...</div>
            <canvas id="audioVisualizer"></canvas>

            <div id="reportCard" class="hidden">
                <div id="analysisResult"></div> 
                <button id="downloadBtn" class="btn download" onclick="downloadPDF()">üì• –•–∞—Ç—Ç–∞–º–∞–Ω—ã –∂“Ø–∫—Ç–µ—É (PDF)</button>
            </div>
        </div> 
    </div>
    
    <script>
        // –ì–ª–æ–±–∞–ª–¥—ã –∞–π–Ω—ã–º–∞–ª—ã–ª–∞—Ä
        let audioContext, analyser, microphone, javascriptNode;
        let isRecording = false;
        let timelineData = []; 
        let teacherName = "", subjectName = "", className = "";

        // 1. –î–ï–†–ï–ö–¢–ï–†–î–Ü –°–ê“ö–¢–ê–£ –§–£–ù–ö–¶–ò–Ø–°–´
        function saveData() {
            // –ñ–æ–ª–∞“õ—Ç–∞—Ä–¥–∞–Ω –º”ô–Ω–¥–µ—Ä–¥—ñ –∞–ª—É
            const tInput = document.getElementById('teacherNameInput').value;
            const sInput = document.getElementById('subjectInput').value;
            const cInput = document.getElementById('gradeInput').value;

            // –¢–µ–∫—Å–µ—Ä—É
            if(tInput.trim() === "" || sInput.trim() === "" || cInput.trim() === "") {
                alert("“ö–∞—Ç–µ: –ë–∞—Ä–ª—ã“õ –∂–æ–ª–∞“õ—Ç–∞—Ä–¥—ã —Ç–æ–ª—Ç—ã—Ä—É –º—ñ–Ω–¥–µ—Ç—Ç—ñ!");
                return;
            }

            // –°–∞“õ—Ç–∞—É
            teacherName = tInput;
            subjectName = sInput;
            className = cInput;

            // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—Ç—ñ –∞—à—É
            document.getElementById('displayTeacher').innerText = teacherName;
            document.getElementById('displaySubject').innerText = `${subjectName} (${className})`;
            
            document.getElementById('loginModal').style.display = "none"; // –ú–æ–¥–∞–ª—å–¥—ã –∂–∞–±—É
            
            const main = document.getElementById('mainContainer');
            main.classList.remove("blur");
            main.style.filter = "none";
            main.style.pointerEvents = "all";
            
            document.getElementById('startBtn').disabled = false;
        }

        // 2. –¢–ê–õ–î–ê–£–î–´ –ë–ê–°–¢–ê–£
        async function startAnalysis() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
                analyser.fftSize = 2048; 

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                isRecording = true;
                timelineData = []; 
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('reportCard').classList.add('hidden');

                const canvas = document.getElementById('audioVisualizer');
                const ctx = canvas.getContext('2d');
                const speakerIndicator = document.getElementById('speakerIndicator');

                javascriptNode.onaudioprocess = () => {
                    if (!isRecording) return;
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);

                    let values = 0, maxIndex = 0, maxVal = 0;
                    for (let i = 0; i < array.length; i++) {
                        values += array[i];
                        if(array[i] > maxVal) { maxVal = array[i]; maxIndex = i; }
                    }
                    const volume = values / array.length;
                    const frequency = maxIndex * (audioContext.sampleRate / analyser.fftSize);

                    let currentStatus = "silence";
                    if (volume < 10) {
                        currentStatus = "silence";
                        speakerIndicator.innerText = "ü§´ “Æ–Ω—Å—ñ–∑–¥—ñ–∫ (–ñ“±–º—ã—Å —Å”ô—Ç—ñ)";
                        speakerIndicator.className = "speaker-box";
                    } else {
                        if (frequency < 280) {
                            currentStatus = "teacher";
                            speakerIndicator.innerText = "üë®‚Äçüè´ –ú“±“ì–∞–ª—ñ–º —Å”©–π–ª–µ—É–¥–µ";
                            speakerIndicator.className = "speaker-box teacher-mode";
                        } else {
                            currentStatus = "student";
                            speakerIndicator.innerText = "üôã‚Äç‚ôÇÔ∏è –û“õ—É—à—ã –∂–∞—É–∞–ø –±–µ—Ä—É–¥–µ";
                            speakerIndicator.className = "speaker-box student-mode";
                        }
                    }
                    if (Math.random() > 0.8) timelineData.push(currentStatus);
                    
                    // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    const barWidth = (canvas.width / array.length) * 2.5;
                    let x = 0;
                    for (let i = 0; i < array.length; i++) {
                        let barHeight = array[i] / 2;
                        ctx.fillStyle = `rgb(50, ${barHeight + 100}, 200)`;
                        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                        x += barWidth + 1;
                    }
                };
            } catch (err) { alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω —ñ—Å–∫–µ “õ–æ—Å—ã–ª–º–∞–¥—ã! –ë—Ä–∞—É–∑–µ—Ä–¥–µ —Ä“±“õ—Å–∞—Ç –±–µ—Ä—ñ“£—ñ–∑."); }
        }

        // 3. –ê–Ø“ö–¢–ê–£ –ñ”ò–ù–ï –ï–°–ï–ü
        function stopAnalysis() {
            isRecording = false;
            if(audioContext) audioContext.close();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('speakerIndicator').innerText = "üõë –¢–∞–ª–¥–∞—É –∞—è“õ—Ç–∞–ª–¥—ã";
            generateReport();
        }

        function formatTime(seconds) {
            seconds = Math.round(seconds);
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return m === 0 ? `${s} —Å–µ–∫` : `${m} –º–∏–Ω ${s} —Å–µ–∫`;
        }

        // 4. –ï–°–ï–ü –ñ”ò–ù–ï PDF “ö“∞–†–ê–°–¢–´–†–£
        function generateReport() {
            document.getElementById('reportCard').classList.remove('hidden');

            let t = 0, s = 0, sil = 0;
            timelineData.forEach(d => {
                if (d === 'teacher') t++; else if (d === 'student') s++; else sil++;
            });
            const factor = 0.09; 
            const tSec = t * factor, sSec = s * factor, silSec = sil * factor;

            let narrative = "";
            const partSize = Math.floor(timelineData.length / 3);
            const startData = timelineData.slice(0, partSize);
            let startTeacher = startData.filter(d => d === 'teacher').length;
            if (startTeacher > startData.length * 0.5) narrative += "<p>‚úÖ <b>–°–∞–±–∞“õ—Ç—ã“£ –±–∞—Å—ã:</b> –¢–∞“õ—ã—Ä—ã–ø—Ç—ã —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä—É–¥–µ–Ω –±–∞—Å—Ç–∞–ª–¥—ã. “∞–π—ã–º–¥–∞—Å—Ç—ã—Ä—É –∫–µ–∑–µ“£—ñ —Å”ô—Ç—Ç—ñ ”©—Ç—Ç—ñ.</p>";
            else narrative += "<p>‚ö†Ô∏è <b>–°–∞–±–∞“õ—Ç—ã“£ –±–∞—Å—ã:</b> “∞–π—ã–º–¥–∞—Å—Ç—ã—Ä—É –∫–µ–∑–µ“£—ñ –±–∞—è—É ”©—Ç—Ç—ñ –Ω–µ–º–µ—Å–µ –±—ñ—Ä–¥–µ–Ω –ø—Ä–∞–∫—Ç–∏–∫–∞ –±–∞—Å—Ç–∞–ª–¥—ã.</p>";

            let midData = timelineData.slice(partSize, partSize*2);
            let midStudent = midData.filter(d => d === 'student').length;
            if (midStudent > midData.length * 0.2) narrative += "<p>‚úÖ <b>–ù–µ–≥—ñ–∑–≥—ñ –±”©–ª—ñ–º:</b> –û“õ—É—à—ã–ª–∞—Ä –±–µ–ª—Å–µ–Ω–¥—ñ “õ–∞—Ç—ã—Å—Ç—ã, —Å“±—Ä–∞“õ-–∂–∞—É–∞–ø ”ô–¥—ñ—Å—ñ “õ–æ–ª–¥–∞–Ω—ã–ª–¥—ã.</p>";
            else narrative += "<p>‚ÑπÔ∏è <b>–ù–µ–≥—ñ–∑–≥—ñ –±”©–ª—ñ–º:</b> –û“õ—É—à—ã–ª–∞—Ä –∫”©–±—ñ–Ω–µ —Ç—ã“£–¥–∞—É—à—ã —Ä”©–ª—ñ–Ω–¥–µ –±–æ–ª–¥—ã –Ω–µ–º–µ—Å–µ –∂–∞–∑–±–∞—à–∞ –∂“±–º—ã—Å –æ—Ä—ã–Ω–¥–∞–¥—ã.</p>";

            // PDF –ú–∞–∑–º“±–Ω—ã
            const resultDiv = document.getElementById('analysisResult');
            resultDiv.innerHTML = `
                <div style="font-family: 'Times New Roman', serif; color: #000; padding: 10px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 16pt; text-transform: uppercase;">–°–∞–±–∞“õ—Ç—ã —Ç–∞–ª–¥–∞—É —Ö–∞—Ç—Ç–∞–º–∞—Å—ã</h2>
                        <p style="margin: 0; font-size: 10pt; font-style: italic;">"Education Black Box" –∂“Ø–π–µ—Å—ñ</p>
                    </div>
                    <hr style="border: 1px solid #000; margin-bottom: 15px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12pt; margin-bottom: 20px;">
                        <tr>
                            <td style="padding: 5px; font-weight: bold;">–ö“Ø–Ω—ñ:</td><td style="padding: 5px;">${new Date().toLocaleDateString()}</td>
                            <td style="padding: 5px; font-weight: bold;">–ú“±“ì–∞–ª—ñ–º:</td><td style="padding: 5px;">${teacherName}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; font-weight: bold;">–£–∞“õ—ã—Ç—ã:</td><td style="padding: 5px;">${new Date().toLocaleTimeString()}</td>
                            <td style="padding: 5px; font-weight: bold;">–ü”ô–Ω/–°—ã–Ω—ã–ø:</td><td style="padding: 5px;">${subjectName} (${className})</td>
                        </tr>
                    </table>
                    <div style="font-size: 14pt; font-weight: bold; border-bottom: 1px solid #000; margin-bottom: 10px;">1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞–ª—ã“õ –∫”©—Ä—Å–µ—Ç–∫—ñ—à—Ç–µ—Ä</div>
                    <ul style="font-size: 12pt; line-height: 1.6;">
                        <li>üë®‚Äçüè´ –ú“±“ì–∞–ª—ñ–º–Ω—ñ“£ —Å”©–π–ª–µ—É —É–∞“õ—ã—Ç—ã: <b>${formatTime(tSec)}</b></li>
                        <li>üôã‚Äç‚ôÇÔ∏è –û“õ—É—à—ã–Ω—ã“£ —Å”©–π–ª–µ—É —É–∞“õ—ã—Ç—ã: <b>${formatTime(sSec)}</b></li>
                        <li>ü§´ “Æ–Ω—Å—ñ–∑–¥—ñ–∫ (–ñ“±–º—ã—Å —Å”ô—Ç—ñ): <b>${formatTime(silSec)}</b></li>
                    </ul>
                    <div style="font-size: 14pt; font-weight: bold; border-bottom: 1px solid #000; margin-top: 20px; margin-bottom: 10px;">2. ”ò–¥—ñ—Å—Ç–µ–º–µ–ª—ñ–∫ —Ç–∞–ª–¥–∞—É</div>
                    <div style="font-size: 12pt; text-align: justify; line-height: 1.4; text-indent: 30px;">${narrative}</div>
                    <br><br><br>
                    <table style="width: 100%; font-size: 12pt; margin-top: 30px;">
                        <tr>
                            <td style="text-align: center; width: 50%;">_______________________<br>(–ú“±“ì–∞–ª—ñ–º–Ω—ñ“£ “õ–æ–ª—ã)</td>
                            <td style="text-align: center; width: 50%;">_______________________<br>(”ò–∫—ñ–º—à—ñ–ª—ñ–∫ ”©–∫—ñ–ª—ñ)</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        // 5. PDF –ñ“Æ–ö–¢–ï–£ (–¢“Ø–∑–µ–ª–≥–µ–Ω)
        function downloadPDF() {
            const element = document.getElementById('analysisResult');
            const opt = {
                margin:       [10, 10, 10, 10], 
                filename:     `${subjectName}_${className}_–•–∞—Ç—Ç–∞–º–∞.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
            };
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>